name: Daily proxy.pac Update

permissions:
  contents: write        # allow GITHUB_TOKEN to push commits

on:
  workflow_dispatch: {}  # manual trigger
  schedule:
    - cron: '0 0 * * *'  # daily at 00:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. NumPy
      - name: Install NumPy
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      # 4. Patch easylist_pac.py so main() actually calls create_pac_file()
      - name: Patch easylist_pac.py main block
        run: |
          # Define user_agent if missing
          grep -q "^user_agent =" easylist_pac.py \
            || sed -i "1i user_agent = 'Mozilla/5.0 (X11; Linux x86_64)'" easylist_pac.py

          # Remove the existing __main__ block (and any trailing sys.exit)
          sed -i '/if __name__ == "__main__":/,$d' easylist_pac.py

          # Append a new __main__ that forces PAC creation
          cat << 'EOF' >> easylist_pac.py
if __name__ == "__main__":
    pac = EasyListPAC()
    pac.create_pac_file()
    print("Generated proxy.pac at", os.path.join(pac.easylist_dir, 'proxy.pac'))
EOF

      # 5. Generate proxy.pac (*don’t* abort on failure—keep your debug flow)
      - name: Generate proxy.pac
        continue-on-error: true
        run: python easylist_pac.py -d . -moff

      # 6. Move from ~/Downloads if still there
      - name: Move proxy.pac into workspace
        run: |
          if [ -f ~/Downloads/proxy.pac ]; then
            mv ~/Downloads/proxy.pac .
          fi

      # 7. Debug: list files so you can see proxy.pac
      - name: Debug workspace
        run: |
          pwd
          ls -la
          ls -R .

      # 8. Commit & push if proxy.pac exists
      - name: Commit and push proxy.pac
        run: |
          if [ -f proxy.pac ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add proxy.pac
            git diff --quiet || git commit -m "Automated daily proxy.pac update"
            git push
          else
            echo "❌ proxy.pac not found; nothing to commit"
          fi
